<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏•‡∏±‡∏¢‡∏Ø</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bj-maroon: #800000;
            --bj-white: #ffffff;
            --bj-light: #f4f7f6;
            --bj-text: #333333;
            --bj-gold: #b08d57;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bj-light); margin: 0; padding: 0; color: var(--bj-text); }
        
        header {
            background-color: var(--bj-white); color: var(--bj-maroon);
            padding: 25px 20px; text-align: center; border-bottom: 5px solid var(--bj-maroon);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .logo { width: 70px; margin-bottom: 10px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--bj-white); padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 25px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0; }
        .stat-box { background: var(--bj-maroon); color: white; padding: 25px; border-radius: 12px; text-align: center; position: relative; }
        .stat-box span { font-size: 2.5rem; font-weight: bold; display: block; margin: 5px 0; }
        .status-tag { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; }

        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-maroon { background: var(--bj-maroon); color: white; }
        .btn-maroon:hover:not(:disabled) { background: #600000; transform: translateY(-2px); }
        .btn-maroon:disabled { background: #ccc; cursor: not-allowed; }
        .btn-outline { border: 2px solid var(--bj-maroon); color: var(--bj-maroon); background: white; }
        .btn-outline:hover { background: #fff0f0; }
        .btn-excel { background: #217346; color: white; width: 100%; }
        .btn-danger { background: #dc3545; color: white; font-size: 0.8rem; padding: 5px 10px; }

        .admin-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 25px; }
        .dash-item { background: #fff; border-bottom: 4px solid var(--bj-maroon); padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .dash-item b { font-size: 1.5rem; color: var(--bj-maroon); }

        .filter-section { background: #f9f9f9; padding: 20px; border-radius: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Sarabun'; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f4f4f4; color: var(--bj-maroon); padding: 15px; text-align: left; border-bottom: 2px solid var(--bj-maroon); }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        
        .time-setting { background: #fff5f5; padding: 15px; border-radius: 10px; border: 1px solid #ffdada; margin-bottom: 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div style="border: 5px solid #f3f3f3; border-top: 5px solid var(--bj-maroon); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
    <p style="margin-top: 15px; font-weight: bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö...</p>
</div>

<header>
    <h1>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏•‡∏±‡∏¢ ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏π‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå</h1>
    <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h3>
</header>

<div class="container">
    
    <section id="page-home" class="page active">
        <div class="card" style="text-align: center;">
            <h2 style="color: var(--bj-maroon);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    ‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô<br><span id="home-junior-count">0</span> ‡∏Ñ‡∏ô
                    <div id="status-junior" class="status-tag">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤...</div>
                </div>
                <div class="stat-box">
                    ‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢<br><span id="home-senior-count">0</span> ‡∏Ñ‡∏ô
                    <div id="status-senior" class="status-tag">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤...</div>
                </div>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button id="btn-junior" class="btn btn-maroon" onclick="openForm('junior')">‡∏°.‡∏ï‡πâ‡∏ô ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</button>
                <button id="btn-senior" class="btn btn-maroon" onclick="openForm('senior')">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</button>
            </div>
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
            <button class="btn btn-outline" onclick="checkAdmin()">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)</button>
        </div>
    </section>

    <section id="page-form" class="page">
        <div class="card">
            <h2 id="form-title" style="color: var(--bj-maroon); border-bottom: 2px solid var(--bj-maroon); padding-bottom: 10px;">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
            <form id="enrollForm">
                <input type="hidden" id="studentLevel">
                <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)</label><input type="text" id="fullname" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏°‡∏®‡∏£‡∏µ ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input type="text" id="sid" maxlength="5" required></div>
                    <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input type="number" id="no" required></div>
                </div>
                <div class="form-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô / ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="room" required></select></div>
                <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (@br.ac.th ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</label><input type="email" id="email" placeholder="sXXXXX@br.ac.th" required></div>
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</label>
                    <select id="clubSelect" required onchange="updateTeacherHint()"></select>
                    <div id="teacher-hint" style="margin-top: 10px; color: var(--bj-maroon); font-weight: bold;"></div>
                </div>
                <div style="margin-top: 25px;">
                    <button type="submit" id="submitBtn" class="btn btn-maroon">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
                    <button type="button" class="btn btn-outline" onclick="goPage('page-home')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </section>

    <section id="page-admin" class="page">
        <div class="card">
            <h2 style="color: var(--bj-maroon);">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="time-setting">
                <h4 style="margin-top:0">üïí ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡∏£‡∏∞‡∏ö‡∏ö</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>‡∏°.‡∏ï‡πâ‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏° - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
                        <input type="datetime-local" id="time-jr-start">
                        <input type="datetime-local" id="time-jr-end" style="margin-top:5px">
                    </div>
                    <div>
                        <label>‡∏°.‡∏õ‡∏•‡∏≤‡∏¢ (‡πÄ‡∏£‡∏¥‡πà‡∏° - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
                        <input type="datetime-local" id="time-sr-start">
                        <input type="datetime-local" id="time-sr-end" style="margin-top:5px">
                    </div>
                </div>
                <button class="btn btn-maroon" style="margin-top:15px; width:100%" onclick="saveConfig()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤</button>
            </div>
            <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</h4>
            <div class="admin-dashboard" id="admin-dash"></div>
            <div class="filter-section">
                <div><label>‡∏ä‡πà‡∏ß‡∏á‡∏ä‡∏±‡πâ‡∏ô</label><select id="f-level" onchange="refreshAdminTable()"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="junior">‡∏°.‡∏ï‡πâ‡∏ô</option><option value="senior">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</option></select></div>
                <div><label>‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</label><select id="f-club" onchange="refreshAdminTable()"><option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</option></select></div>
                <div><label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="f-room" onchange="refreshAdminTable()"><option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option></select></div>
                <div><label>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label><button class="btn btn-excel" onclick="exportSmartExcel()">Excel (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á)</button></div>
            </div>
            <div style="overflow-x: auto;">
                <table id="admin-table">
                    <thead>
                        <tr><th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</th></tr>
                    </thead>
                    <tbody id="admin-tbody"></tbody>
                </table>
            </div>
            <button class="btn btn-outline" style="margin-top:20px" onclick="goPage('page-home')">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</button>
        </div>
    </section>
</div>

<script>
    // --- Configuration ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzE9BQyMmTYPvVmFAXiA-berYbWxma5mfvOfBD8ZxgT7f1N_lFy_Hm5Tmb5hJIpGvSW/exec"; 
    
    const clubs = [
        { id: 1, name: "‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", teacher: "‡∏Ñ‡∏£‡∏π‡∏ò‡∏ô‡∏†‡∏π‡∏°‡∏¥ ‡∏ó‡πâ‡∏≤‡∏ß‡∏°‡∏∞‡∏•‡∏¥", limit: 30 },
        { id: 2, name: "‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", teacher: "‡∏Ñ‡∏£‡∏π‡∏•‡∏¥‡∏ô‡∏î‡∏≤ ‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞", limit: 30 },
        { id: 3, name: "‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤", teacher: "‡∏Ñ‡∏£‡∏π‡∏à‡∏á‡∏Å‡∏•‡∏Å‡∏£ ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ó‡∏´‡∏≤‡∏£", limit: 30 },
        { id: 4, name: "‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå", teacher: "‡∏Ñ‡∏£‡∏π‡∏ì‡∏±‡∏ä‡∏ä‡∏ô‡∏°‡πå ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏ò‡∏≤‡∏î‡∏≤", limit: 30 }
    ];

    let enrollments = [];
    let config = JSON.parse(localStorage.getItem('bj_config')) || {
        junior: { start: "", end: "" },
        senior: { start: "", end: "" }
    };

    // --- Core Functions ---
    async function loadDataFromSheet() {
    // document.getElementById('loader').style.display = 'flex'; // ‡∏õ‡∏¥‡∏î loader
    try {
        const response = await fetch(SCRIPT_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        enrollments = await response.json();
        checkSystemStatus();
    } catch (e) {
        console.error("Fetch Error:", e);
        // ‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î alert ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

    // window.onload = loadDataFromSheet;

    function goPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'page-home') checkSystemStatus();
    }

    function checkSystemStatus() {
        document.getElementById('home-junior-count').innerText = enrollments.filter(e => e.level === 'junior' || e.room.includes('‡∏°.1') || e.room.includes('‡∏°.2') || e.room.includes('‡∏°.3')).length;
        document.getElementById('home-senior-count').innerText = enrollments.filter(e => e.level === 'senior' || e.room.includes('‡∏°.4') || e.room.includes('‡∏°.5') || e.room.includes('‡∏°.6')).length;
        
        const now = new Date();
        ['junior', 'senior'].forEach(type => {
            const btn = document.getElementById(`btn-${type}`);
            const status = document.getElementById(`status-${type}`);
            const start = config[type].start ? new Date(config[type].start) : null;
            const end = config[type].end ? new Date(config[type].end) : null;

            if(!start || !end) {
                status.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤"; btn.disabled = true;
            } else if(now < start) {
                status.innerText = "‡πÄ‡∏õ‡∏¥‡∏î " + start.toLocaleString('th-TH', {dateStyle:'short', timeStyle:'short'});
                btn.disabled = true;
            } else if(now > end) {
                status.innerText = "‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß"; btn.disabled = true;
            } else {
                status.innerText = "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà";
                btn.disabled = false;
            }
        });
    }

    // --- Enrollment ---
    function openForm(level) {
        document.getElementById('studentLevel').value = level;
        document.getElementById('form-title').innerText = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° ‡∏£‡∏∞‡∏î‡∏±‡∏ö" + (level === 'junior' ? "‡∏°.‡∏ï‡πâ‡∏ô" : "‡∏°.‡∏õ‡∏•‡∏≤‡∏¢");
        
        const roomSelect = document.getElementById('room');
        roomSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>';
        const startG = level === 'junior' ? 1 : 4;
        for(let g=startG; g<startG+3; g++) {
            for(let r=1; r<=8; r++) roomSelect.innerHTML += `<option value="‡∏°.${g}/${r}">‡∏°.${g}/${r}</option>`;
        }

        const clubSelect = document.getElementById('clubSelect');
        clubSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° --</option>';
        clubs.forEach(c => {
            const count = enrollments.filter(e => e.clubName === c.name).length;
            clubSelect.innerHTML += `<option value="${c.id}" ${count >= c.limit ? 'disabled' : ''}>${c.name} (${count}/${c.limit})</option>`;
        });
        
        goPage('page-form');
    }

    function updateTeacherHint() {
        const cid = document.getElementById('clubSelect').value;
        const hint = document.getElementById('teacher-hint');
        hint.innerText = cid ? "‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: " + clubs.find(c => c.id == cid).teacher : "";
    }

    document.getElementById('enrollForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const email = document.getElementById('email').value;
        const sid = document.getElementById('sid').value;

        if(!email.endsWith('@br.ac.th')) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏• @br.ac.th ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        if(enrollments.find(e => e.sid == sid)) return alert("‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");

        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

        const record = {
            sid: sid,
            fullname: document.getElementById('fullname').value,
            no: document.getElementById('no').value,
            room: document.getElementById('room').value,
            clubName: clubs.find(c => c.id == document.getElementById('clubSelect').value).name,
            email: email,
            timestamp: new Date().toLocaleString('th-TH')
        };

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(record)
            });
            const result = await response.json();
            if(result.result === "success") {
                alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                location.reload();
            } else {
                alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + result.message);
            }
        } catch (err) {
            alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
        } finally {
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£";
        }
    };

    // --- Admin ---
    function checkAdmin() {
        if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin:") === "123456") {
            document.getElementById('time-jr-start').value = config.junior.start;
            document.getElementById('time-jr-end').value = config.junior.end;
            document.getElementById('time-sr-start').value = config.senior.start;
            document.getElementById('time-sr-end').value = config.senior.end;
            
            const fClub = document.getElementById('f-club');
            fClub.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</option>';
            clubs.forEach(c => fClub.innerHTML += `<option value="${c.name}">${c.name}</option>`);

            refreshAdminTable();
            goPage('page-admin');
        } else {
            alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î!");
        }
    }

    function saveConfig() {
        config.junior.start = document.getElementById('time-jr-start').value;
        config.junior.end = document.getElementById('time-jr-end').value;
        config.senior.start = document.getElementById('time-sr-start').value;
        config.senior.end = document.getElementById('time-sr-end').value;
        localStorage.setItem('bj_config', JSON.stringify(config));
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        checkSystemStatus();
    }

    function refreshAdminTable() {
        const lv = document.getElementById('f-level').value;
        const cl = document.getElementById('f-club').value;
        const rm = document.getElementById('f-room').value;
        
        const dash = document.getElementById('admin-dash');
        dash.innerHTML = '';
        ['‡∏°.1','‡∏°.2','‡∏°.3','‡∏°.4','‡∏°.5','‡∏°.6'].forEach(g => {
            const count = enrollments.filter(e => e.room.includes(g)).length;
            dash.innerHTML += `<div class="dash-item"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö</span><br><b>${g}</b><br><span>${count} ‡∏Ñ‡∏ô</span></div>`;
        });

        const tbody = document.getElementById('admin-tbody');
        tbody.innerHTML = '';
        const filtered = enrollments.filter(e => {
            const isJr = e.room.includes('‡∏°.1') || e.room.includes('‡∏°.2') || e.room.includes('‡∏°.3');
            const matchLv = (lv === 'all') || (lv === 'junior' && isJr) || (lv === 'senior' && !isJr);
            return matchLv && (cl === 'all' || e.clubName === cl) && (rm === 'all' || e.room === rm);
        });

        filtered.forEach(e => {
            tbody.innerHTML += `<tr><td>${e.sid}</td><td>${e.fullname}</td><td>${e.room}</td><td>${e.no}</td><td>${e.clubName}</td></tr>`;
        });
    }

    function exportSmartExcel() {
        let csv = "\uFEFF‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß,‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°,‡∏≠‡∏µ‡πÄ‡∏°‡∏•\n";
        enrollments.forEach(e => {
            csv += `${e.sid},${e.fullname},${e.room},${e.no},${e.clubName},${e.email}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°_‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.csv`;
        link.click();
    }
    
    // Spin Animation
    const style = document.createElement('style');
    style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(style);
</script>

</body>
</html>















